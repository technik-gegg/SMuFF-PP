## SMuFF-PP - a Post Processor for GCode files used for multi material printing

### New version using .NET 7.0

This relatively simple app is a post processor which is supposed to be used in conjunction to your favorite slicer for 3D models.

This app is meant to reduce the amount of wasted material while 3D printing multi material/multi color models, a.k.a purged material. Here's a short video of the output generated by this app in action:

[![Video](http://img.youtube.com/vi/SHiTa84pGX0/0.jpg)](https://youtu.be/SHiTa84pGX0)

The GCode (original and generated) are contained in this repository for testing purposes.

Purging usually takes place after a tool change has been processed in order to get rid of the remains of the previous filament still sitting in the nozzle.
There are several different methods to achieve this. The most common method is using a Purge- or Prime tower in your print.
Although this is the most convenient method to set up, it's also the most wastefull. A Purge- or Prime tower can contain more material than the model itself.
I've posted a comprehensive article about the different methods [here](https://sites.google.com/view/the-smuff/faq/purge-bin-vs-purge-tower).

The SMuFF-PP app focuses on a different method: It tries to relocate tool changes to a previous position, where the filament - that otherwise would stay in the hotend and needs to be purged - is part of the current layer/tool. Hence, there's no residue in the hotend and the print can continue right after the tool change.
To accomplish this, SMuFF-PP parses the existing GCode file for tool changes (T1, T2, T3...) and tries to move them ahead of the original position. The distance (or better the extrusion length) for the relocation is defined either in the **settings.xml** file via the **Treshold** parameter or via command line with the **-t=nnn** opton, whereas *nnn* describes the distance (or extrusion amount).
In case SMuFF-PP can't find a decent relocation position (mostly because the extruded amount isn't long enough), it'll insert a code for purging out the old filament right after the tool change has taken place.
This "purging code" tells the printer what to do, i.e. where to move for purging, or how much of filament needs to be purged out. You have to define these commands according to your 3D printer and printing environment and put them into the **settings.xml** file.

Here's a simple example for such a purging code:

```gcode
M83             ; set extruder to relative mode (important!)
G1 E{0:N4} F340 ; Purge out old filament
M400            ; wait for move to finish
G4 P2500        ; wait for nozzle oozing out a bit
M82             ; set extruder back to absolute mode
```

The **G1 E** code in the example above is used to purge the filament out. The *{0:N4}* parameter placeholder after **E** is the amount of extrusion in mm. You can leave the parameter placeholder *{0:N4}* as it is and SMuFF-PP will replace it by the **Treshold** value for you, or you may also apply an absolute value to it, it's up to you.
Allowing the app to replace the value is the safer choice, since you have to apply this value only once in *settings.xml*.

Be aware that you have to figure the correct treshold value yourself. It depends on a couple of different parameters, such as your type of hotend and material used.
The value set in this configuration reflects the setup of a SMuFF using the Filament-Cutter on an Ender-3 Bowden style hotend. Thus, the distance between Filament-Cutter blade and nozzle is about 54 mm long.
It is possible to shorten this distance by allowing the SMuFF to retract a bit of filament before cutting it. A safe value would be the height of the heatblock, which usually is around 20 mm. 20 mm less can make a huge difference for the relocations, which of course highly depends on the model you're printing.
This version also supports skipping tool changes. This feature is initiated by setting the **skipThreshold** value in *settings.xml*. If this value is set to anything above 0 (let's say 3mm for example), SMuFF-PP will discard the tool change completely if the extruded amount for the tool in question is below this threshold value. You can go higher on this value but keep in mind that you will loose details on the print.

***

## Recommended slicer settings

In order to use this post processor, you have to ensure that your slicer is generating GCode using **relative extrusions**! Absolute extrusions will not work here!

***

## How to run this app

This program is a console app written in C# which utlizes the **.NET 7.0 framework**. In order to run this app, open a command line window and type:

>smuff-pp *input_gcode_file*

Before you run it the first time, make sure you have changed the parameters in your **settings.xml** according to your 3D printers environment, or add the option **-t=nnn** to change the threshold value.

As you run it, the output will be something like this (if **Verbose** is set to **true** or the -v option has been applied):

```text

>>> SMuFF-PP - GCode post processor for purge-less multi material printing.
>>> Version 2.0.2023.2

Input file:             "Josef_Prusa (E3-MMU) ECO.gcode"
Output file:            "Josef_Prusa (E3-MMU) ECO_(SMuFF).gcode"
Purge threshold:        54.000
Skip threshold:         0.000
Slicer:                 PrusaSlicer 2.5.0+win64 on 2023-01-29 at 08:23:24 UTC

Printing starts at line 48 with T0
T1 in line 2351:        Relocated by -54.009 mm (to line 2024)
T2 in line 5365:        Relocated by -54.030 mm (to line 4909)
...
T1 in line 227792:      Relocated by -54.074 mm (to line 227406)
T2 in line 230702:      Relocated by -54.022 mm (to line 230257)

Done parsing input file, output file written.
----------------------------------------------------------------------------------------------
Statistics: 60 tool change(s); 0 skipped; 60 relocation(s) accomplished; 0 purge(s) needed.
----------------------------------------------------------------------------------------------
```

It may differ based on the input file and your applied settings.

If you'd like an executable for another OS than MS Windows, open a *Terminal* window in VSCode and key in:

If you're on **MacOS** try using:

>dotnet publish --configuration Release **-r osx-x64**

On **Linux** you may use:

>dotnet publish --configuration Release **-r linux-x64**

**Please notice**: *I haven't tested the MacOS/Linux options. I take Microsofts word for it. If you do, please let me know the outcome.*

After the app has been published, copy all the files from the *.\bin\release\net7.0\\{OS}-x64\publish\\* into your favorite working folder and also copy the **settings.xml** file into that same folder.

***

## Integration into your slicer

The most convenient way to use this app is to integrate it into your slicer. Most slicers nowadays do allow you running some post processing on the generated GCode file by defining an shell command, which gets executed after the GCode has been generated/saved.
Please refer to your favorite slicers documentation on how to achieve this.

***
## Recent changes

**2023-02-06**

- moved to latest .NET framework 7.0.
- removed the relocation into Simplify3D's *Ooze shield* completely, because, seriously, who's still using Simplify3D?
- added skip tool change feature (and skipThreshold).
- moved Regular Expressions for parsing into *settings.xml* to allow adopting those quickly.
- added **PreToolChangeCode** and **PostToolChangeCode** in *settings.xml* which will hold the GCode inserted before and after the **relocated** tool change command. These are primarily used to retract/unretract filament before/after tool change to avoid oozing. Commands G10/G11 for firmware retraction are recommended.
- added a header in the post processed file, so you're able to look up when you ran the post processing and what thresholds are being used.
- added support for **G2** and **G3** Arc moves, as well as **G5** for BÃ©zier cubic spline moves.
